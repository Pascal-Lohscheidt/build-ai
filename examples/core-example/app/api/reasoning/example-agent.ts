import { AgentFactory } from '@m4trix/core';
import OpenAI from 'openai';
import { MessageEvent, MessageStreamChunkEvent } from './events';
import { filter, from, lastValueFrom, map, reduce, take, tap } from 'rxjs';

export const exampleAgent = AgentFactory.run()
  .listensTo([MessageEvent])
  .emits([MessageStreamChunkEvent, MessageEvent])
  .logic(async ({ triggerEvent, emit, contextEvents }) => {
    if (!MessageEvent.is(triggerEvent)) {
      return;
    }

    const message = triggerEvent.payload.message;
    const role = triggerEvent.payload.role as 'user' | 'assistant';
    const messageHistory = contextEvents.all.filter(MessageEvent.is);

    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    const stream = await openai.chat.completions.create({
      model: 'gpt-4o',
      stream: true,
      messages: [
        {
          role: 'system',
          content:
            'You are a helpful assistant. Think step by step and explain your reasoning.',
        },
        ...messageHistory.map((event) => ({
          role: event.payload.role as 'user' | 'assistant',
          content: event.payload.message,
        })),
        { role, content: message },
      ],
    });

    // Streaming the response from the OpenAI API
    const finalResponse = await lastValueFrom(
      from(stream).pipe(
        map((chunk) => chunk.choices[0]?.delta?.content),
        filter((content): content is string => content != null),
        map((content) =>
          MessageStreamChunkEvent.make({
            chunk: content,
            isFinal: false,
            role: 'assistant',
          }),
        ),
        tap(emit), // Emit the stream chunks
        filter(MessageStreamChunkEvent.is),
        reduce((acc, event) => acc + event.payload.chunk, ''),
        take(1),
      ),
    );

    emit(
      MessageStreamChunkEvent.make({
        chunk: '',
        isFinal: true,
        role: 'assistant',
      }),
    );
    emit(
      MessageEvent.make({
        message: finalResponse,
        role: 'assistant',
      }),
    );
  })
  .produce({});
